#!/usr/bin/env node

if (
  !process.argv.includes("pre-commit") &&
  !process.argv.includes("post-commit")
) {
  console.log(`
▄▄▄         ▄· ▄▌ ▄▄▄· ▄▄▌
▀▄ █·▪     ▐█▪██▌▐█ ▀█ ██•
▐▀▀▄  ▄█▀▄ ▐█▌▐█▪▄█▀▀█ ██▪
▐█•█▌▐█▌.▐▌ ▐█▀·.▐█ ▪▐▌▐█▌▐▌
.▀  ▀ ▀█▄▀▪  ▀ •  ▀  ▀ .▀▀▀
`);
}

const { spawn, spawnSync } = require("child_process");
const { existsSync } = require("fs");
const { join } = require("path");

const basePath = join(
  process.cwd(),
  ...".output/.cache/base/main.js".split("/")
);
const args = process.argv.slice(2);

const main = async () => {
  if (!existsSync(join(process.cwd(), "node_modules"))) {
    await new Promise((resolve) => {
      const pnpm = spawn("pnpm", ["i"], { stdio: "inherit", shell: true });
      pnpm.on("exit", resolve);
    });
  }

  while (true) {
    const res = spawnSync(
      process.execPath,
      ["-r", "@swc-node/register", "pkgs/base/src/builder/base.ts", ...args],
      {
        stdio: "inherit",
        env: {
          ...process.env,
          NODE_PATH: join(process.cwd(), "pkgs", "base", "node_modules"),
        },
        cwd: process.cwd(),
      }
    );

    if (res.status === 1) {
      break;
    } else {
      if (existsSync(basePath)) {
        runBase();
      }
    }
  }
};

const runBase = () => {
  spawnSync(process.execPath, ["--enable-source-maps", basePath, ...args], {
    env: {
      ...process.env,
      NODE_PATH: join(process.cwd(), "pkgs", "base", "node_modules"),
    },
    cwd: process.cwd(),
    stdio: "inherit",
  });
};

main();
